---
layout: post
title: "Кэш и ненависть в iBooks"
description: "Как устроен механизм кэширования медиафайлов в iBooks Author"
keywords: ["apple", "ibooks", "author", "cache"]
---

<img class="img-center" src="http://31808.selcdn.ru/it-prm/pics/hero_ibooks_author.png" alt="iBooks Author">

Разрабатывая книгу в iBooks Author, я столкнулись с «необъяснимыми» проблемами с HTML5 AUDIO в написанных мной виджетах. Аудио то играло, то не играло, звук иногда пропадал после исправлений, которые не затрагивали ни JS, ни HTML, ни CSS ( например после замены дефисов на тире ). Долгим и, к сожалению, эмпирическим путем я установил корень проблемы — кириллица в имени файла книги и в имени файла виджета. Вроде бы все легко — переименовываем книгу, переименовываем виджет, профит! С файлом книги, естественно, проблем не возникло, а с виджетом все оказалось чуть-чуть сложнее.


### WTF?! Cache!

Никто не может просто взять и переименовать виджет. iBooks Author имеет свой механизм кэширования. Упрощенная модель кэша работает примерно так


<ol> 
<li><b>Получаем хэш файла</b>, который пользователь пытается добавить в книгу.</li>
<li><b>Сверяем хэш файла с хэшами уже существующих файлов</b> этого типа. </li>
<li><b>Решаем, использовать ли новый файл, либо сослаться на файл, который уже существует в книге</b> основываясь на результате предыдущего пункта.</li>
</ol>
 
Можно очень долго пытаться добавить переименованый латиницей файл в книгу, но **пока в код виджета не добавишь хотя бы один пробел — iBooks** не станет добавлять виджет, и вместо этого **будет ссылаться на уже существующий файл, который не будет работать из-за кириллицы в названии.**