---

layout: post
title: "Как работает CommonJS"
description: ""
keywords: ["личное"]

---

TODO: Поработать над структурой


### И сразу… Дисклеймер

_На самом деле, все несколько сложнее, чем здесь написано, но, 
я надеюсь, что хорошее общее представление о работе с CommonJS по этой статье
вполне можно составить._

## Что такое CommonJS?

CommonJS — это модульная система, которая используется в NodeJS. ???

За последние несколько лет CommonJS все ближе подбирается к браузерам: существует
достаточно большое количество утилит, позволяющее использовать CommonJS-модули
в браузере. К примеру, [browserify], [clinch], [Component] и тд.

## Как работает CommonJS

Объясню устройство CommonJS Не слишком углубляясь в подробности:

- Содержимое CommonJS модулей оборачивается в замыкания:
  <pre><code>function (require, module) {
    // module code
  }</code></pre>
- функция `require` позволяет подключать другие модули по имени(из `node_modules`),
  или по относительному пути к файлу модуля. Пример: `require('./my-awesome-module.js')`.
- Oбъект `module.exports` — это объект или примитив, который получит пользователь,
  подключив модуль через `require`.
- Замыкания кешуруются в специальный хеш, где ключ равен абсолютному пути к файлу
  модуля;
- При запросе закешированного файла возвращается ссылка на существующее замыкание;

Вот, в общем-то и все устройство. В NodeJS через аргументы замыкания передаются
еще и глобальные объекты `process` и `global`. Ну и для `module.exports` есть
которкий синоним `exports`, тоже передается в аргументах. Правда примитив
в него просто так записать не получится. 

### Пример модуля

{% highlight javascript %}
'use strict';

var $ = require('jquery')
  , counter = 0
  ;

exports.add = function (count) {
  counter += count || 1;
};

exports.get = function () {
  return counter;
}

exports.reset = function () {
  counter = 0;
}
{% endhighlight %}


Этот пример достаточно наглядно показывает, что в сущности CommonJS-модуль — это
замыкание. 


## Поддержка

Часто так случается, что определенный модуль не поддерживает CommonJS. В большинстве
случаев добавить поддержку достаточно тривиально. Вот пример обертки над jQuery-плагином,
позволяющей использовать его с CommonJS и AMD:

{% highlight javascript %}
(function (factory) {
  "use strict";
  if (typeof define === 'function' && define.amd) {
    // using AMD
    define(['jquery'], factory);
  // 
  } else if (typeof exports !== 'undefined') {
    using CommonJS
    module.exports = factory;
  } else {
    // no AMD/CommonJS; invoke directly
    factory( (typeof(jQuery) != 'undefined') ? jQuery : window.Zepto );
  }
})(function($) {
  "use strict";
    // plugin code
  });
{% endhighlight %}